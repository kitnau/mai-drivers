From 894beb7d3f21bdb85b2972a43584ce58272e14b2 Mon Sep 17 00:00:00 2001
From: Kali User <kali@example.com>
Date: Sun, 21 Dec 2025 12:47:37 -0500
Subject: [PATCH] pz7

---
 drivers/net/Kconfig                           |   3 +
 drivers/net/ethernet/Kconfig                  |   4 +
 drivers/net/ethernet/Makefile                 |   2 +
 drivers/net/ethernet/testpci/Kconfig          |   8 ++
 drivers/net/ethernet/testpci/Makefile         |   2 +
 .../net/ethernet/testpci/test_pci_driver.c    | 132 ++++++++++++++++++
 6 files changed, 151 insertions(+)
 create mode 100644 drivers/net/ethernet/testpci/Kconfig
 create mode 100644 drivers/net/ethernet/testpci/Makefile
 create mode 100644 drivers/net/ethernet/testpci/test_pci_driver.c

diff --git a/drivers/net/Kconfig b/drivers/net/Kconfig
index ac12eaf11755..f0a9144d3373 100644
--- a/drivers/net/Kconfig
+++ b/drivers/net/Kconfig
@@ -646,5 +646,8 @@ config NETDEV_LEGACY_INIT
 	help
 	  Drivers that call netdev_boot_setup_check() should select this
 	  symbol, everything else no longer needs it.
+	  
+
+
 
 endif # NETDEVICES
diff --git a/drivers/net/ethernet/Kconfig b/drivers/net/ethernet/Kconfig
index 4a1b368ca7e6..d7e228c378f4 100644
--- a/drivers/net/ethernet/Kconfig
+++ b/drivers/net/ethernet/Kconfig
@@ -170,6 +170,8 @@ config OA_TC6
 
 	  To know the implementation details, refer documentation in
 	  <file:Documentation/networking/oa-tc6-framework.rst>.
+	 
+
 
 source "drivers/net/ethernet/packetengines/Kconfig"
 source "drivers/net/ethernet/pasemi/Kconfig"
@@ -204,5 +206,7 @@ source "drivers/net/ethernet/wangxun/Kconfig"
 source "drivers/net/ethernet/wiznet/Kconfig"
 source "drivers/net/ethernet/xilinx/Kconfig"
 source "drivers/net/ethernet/xircom/Kconfig"
+source "drivers/net/ethernet/testpci/Kconfig"
+
 
 endif # ETHERNET
diff --git a/drivers/net/ethernet/Makefile b/drivers/net/ethernet/Makefile
index 2e18df8ca8ec..4a38d6a8b0a7 100644
--- a/drivers/net/ethernet/Makefile
+++ b/drivers/net/ethernet/Makefile
@@ -109,3 +109,5 @@ obj-$(CONFIG_NET_VENDOR_XIRCOM) += xircom/
 obj-$(CONFIG_NET_VENDOR_SYNOPSYS) += synopsys/
 obj-$(CONFIG_NET_VENDOR_PENSANDO) += pensando/
 obj-$(CONFIG_OA_TC6) += oa_tc6.o
+obj-$(CONFIG_TEST_PCI_DRIVER) += testpci/
+
diff --git a/drivers/net/ethernet/testpci/Kconfig b/drivers/net/ethernet/testpci/Kconfig
new file mode 100644
index 000000000000..1b8f1c8a3aca
--- /dev/null
+++ b/drivers/net/ethernet/testpci/Kconfig
@@ -0,0 +1,8 @@
+config TEST_PCI_DRIVER
+	tristate "Test PCI network driver"
+	depends on PCI && NETDEVICES
+	help
+	  Simple test PCI network driver.
+
diff --git a/drivers/net/ethernet/testpci/Makefile b/drivers/net/ethernet/testpci/Makefile
new file mode 100644
index 000000000000..a15f4aa642a2
--- /dev/null
+++ b/drivers/net/ethernet/testpci/Makefile
@@ -0,0 +1,2 @@
+obj-$(CONFIG_TEST_PCI_DRIVER) += test_pci_driver.o
+
diff --git a/drivers/net/ethernet/testpci/test_pci_driver.c b/drivers/net/ethernet/testpci/test_pci_driver.c
new file mode 100644
index 000000000000..77089334568d
--- /dev/null
+++ b/drivers/net/ethernet/testpci/test_pci_driver.c
@@ -0,0 +1,132 @@
+#include <linux/io.h>
+#include <linux/kernel.h>
+#include <linux/module.h>
+#include <linux/pci.h>
+#include <linux/netdevice.h>
+#include <linux/etherdevice.h>
+
+#define DRIVER_NAME "test_pci_driver"
+
+static const struct pci_device_id pci_eth_device_tbl[] = {
+	{ PCI_DEVICE(0x1AF4, 0x1041) }, // VirtIO network interface device
+	{},
+};
+
+MODULE_DEVICE_TABLE(pci, pci_eth_device_tbl);
+
+struct net_device *netdev;
+
+static int demo_nic_open(struct net_device *dev)
+{
+	pr_info(DRIVER_NAME ": open\n");
+	return 0;
+}
+
+static int demo_nic_release(struct net_device *dev)
+{
+	pr_info(DRIVER_NAME ": release\n");
+	netif_stop_queue(dev);
+	return 0;
+}
+
+static int demo_nic_xmit(struct sk_buff *skb, struct net_device *dev)
+{
+	pr_info(DRIVER_NAME ": xmit\n");
+
+	dev->stats.tx_bytes += skb->len;
+	dev->stats.tx_packets++;
+
+	pr_info(DRIVER_NAME ": %pTN<struct sk_buff>\n", (void *)skb);
+	pr_info(DRIVER_NAME
+		": Packet info - Len: %u, Head: %p, Data: %p, Tail: %d, End: %d\n",
+		skb->len, (void *)skb->head, (void *)skb->data, skb->tail,
+		skb->end);
+
+	pr_info(DRIVER_NAME ": First %d bytes:\n", skb->len);
+	pr_info(DRIVER_NAME ": Hex: ");
+	for (uint i = 0; i < skb->len; i++) {
+		pr_cont("%02x ", skb->data[i]);
+	}
+	pr_cont("\n");
+
+	pr_info(DRIVER_NAME ": Chr: ");
+	for (uint i = 0; i < skb->len; i++) {
+		pr_cont("%c ", skb->data[i]);
+	}
+	pr_cont("\n");
+
+	dev_kfree_skb(skb);
+	return 0;
+}
+
+static int demo_nic_init(struct net_device *dev)
+{
+	pr_info(DRIVER_NAME ": net device initialized\n");
+
+	return 0;
+};
+
+const struct net_device_ops ops = {
+	.ndo_init = demo_nic_init,
+	.ndo_open = demo_nic_open,
+	.ndo_stop = demo_nic_release,
+	.ndo_start_xmit = demo_nic_xmit,
+};
+
+static int pci_driver_probe(struct pci_dev *dev, const struct pci_device_id *ent)
+{
+	int result;
+
+	netdev = alloc_etherdev(0);
+	netdev->netdev_ops = &ops;
+
+	if ((result = register_netdev(netdev))) {
+		pr_err(DRIVER_NAME ": net dev register failed: %d", result);
+		return result;
+	}
+
+	const unsigned long port_addr = pci_resource_start(dev, 0);
+	const int len = pci_resource_len(dev, 0);
+
+	u8 *mapped_ptr = ioremap(port_addr, len);
+
+	int j = 0;
+	const unsigned char *const ptr = mapped_ptr;
+	for (int i = 0; i < len; i++) {
+		if (ptr[i] == 0x70) {
+			printk(KERN_INFO "offset = %d", i);
+			for (j = 0; j < 6; j++) {
+				printk(KERN_INFO "MAC %x %x %x %x %x %x \n",
+				       (unsigned)ptr[i], (unsigned)ptr[i + 1],
+				       (unsigned)ptr[i + 2],
+				       (unsigned)ptr[i + 3],
+				       (unsigned)ptr[i + 4],
+				       (unsigned)ptr[i + 5]);
+			}
+		}
+	}
+
+	iounmap(mapped_ptr);
+
+	return 0;
+}
+
+static void pci_driver_remove(struct pci_dev *dev)
+{
+	pr_info(DRIVER_NAME ": unregistered\n");
+	if (netdev) {
+		unregister_netdev(netdev);
+		free_netdev(netdev);
+		netdev = NULL;
+	}
+}
+
+static struct pci_driver pci_driver = {
+	.name = DRIVER_NAME,
+	.id_table = pci_eth_device_tbl,
+	.probe = pci_driver_probe,
+	.remove = pci_driver_remove,
+};
+module_pci_driver(pci_driver);
+
+MODULE_LICENSE("GPL");
-- 
2.51.0

